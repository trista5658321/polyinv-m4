import sys
def setMacro():
    print(".macro barrett_reduce tar, qinv, q, tmp")
    print("\tsmmulr " + r"\tmp, \tar, \qinv")
    print("\tmls " + r"\tar, \tmp, \q, \tar")
    print(".endm\n")

    print(".macro polymul_4x4_hold_f f01, f23, g01, g23, c0, c1, c2, c3, c4, c5, c6")
    print("\tsmulbb " + r"\c0, \f01, \g01")
    print("\tsmuadx " + r"\c1, \f01, \g01")
    print("\tsmulbb " + r"\c2, \f23, \g01")
    print("\tsmuadx " + r"\c3, \f01, \g23")
    print("\tsmladx " + r"\c3, \f23, \g01, \c3")
    print("\tsmultt " + r"\c4, \f01, \g23")
    print("\tsmuadx " + r"\c5, \f23, \g23")
    print("\tsmultt " + r"\c6, \f23, \g23")
    print("\tpkhbt " + r"\g01, \g23, \g01")
    print("\tsmlad " + r"\c2, \f01, \g01, \c2")
    print("\tsmlad " + r"\c4, \f23, \g01, \c4")
    print(".endm\n")

    print(".macro polymul_4x4_hold_g f01, f23, g01, g23, c0, c1, c2, c3, c4, c5, c6")
    print("\tsmulbb " + r"\c0, \f01, \g01")
    print("\tsmuadx " + r"\c1, \f01, \g01")
    print("\tsmulbb " + r"\c2, \f01, \g23")
    print("\tsmuadx " + r"\c3, \f01, \g23")
    print("\tsmladx " + r"\c3, \f23, \g01, \c3")
    print("\tsmultt " + r"\c4, \f23, \g01")
    print("\tsmuadx " + r"\c5, \f23, \g23")
    print("\tsmultt " + r"\c6, \f23, \g23")
    print("\tpkhbt " + r"\f01, \f23, \f01")
    print("\tsmlad " + r"\c2, \f01, \g01, \c2")
    print("\tsmlad " + r"\c4, \f01, \g23, \c4")
    print(".endm\n")

    print(".macro polymul_4x4_accumulate_456to012 f01, f23, g01, g23, c0, c1, c2, c3, c4, c5, c6")
    print("\tsmlabb " + r"\c0, \f01, \g01, \c4")
    print("\tsmladx " + r"\c1, \f01, \g01, \c5")
    print("\tsmlabb " + r"\c2, \f23, \g01, \c6")
    print("\tsmuadx " + r"\c3, \f01, \g23")
    print("\tsmladx " + r"\c3, \f23, \g01, \c3")
    print("\tsmultt " + r"\c4, \f01, \g23")
    print("\tsmuadx " + r"\c5, \f23, \g23")
    print("\tsmultt " + r"\c6, \f23, \g23")
    print("\tpkhbt " + r"\g01, \g23, \g01")
    print("\tsmlad " + r"\c2, \f01, \g01, \c2")
    print("\tsmlad " + r"\c4, \f23, \g01, \c4")
    print(".endm\n")

    print(".macro polymul_4x4_accumulate_all_hold_f f01, f23, g01, g23, c0, c1, c2, c3, c4, c5, c6")
    print("\tsmlabb " + r"\c0, \f01, \g01, \c0")
    print("\tsmladx " + r"\c1, \f01, \g01, \c1")
    print("\tsmlabb " + r"\c2, \f23, \g01, \c2")
    print("\tsmladx " + r"\c3, \f01, \g23, \c3")
    print("\tsmladx " + r"\c3, \f23, \g01, \c3")
    print("\tsmlatt " + r"\c4, \f01, \g23, \c4")
    print("\tsmladx " + r"\c5, \f23, \g23, \c5")
    print("\tsmlatt " + r"\c6, \f23, \g23, \c6")
    print("\tpkhbt " + r"\g01, \g23, \g01")
    print("\tsmlad " + r"\c2, \f01, \g01, \c2")
    print("\tsmlad " + r"\c4, \f23, \g01, \c4")
    print(".endm\n")

    print(".macro polymul_4x4_accumulate_all_hold_g f01, f23, g01, g23, c0, c1, c2, c3, c4, c5, c6")
    print("\tsmlabb " + r"\c0, \f01, \g01, \c0")
    print("\tsmladx " + r"\c1, \f01, \g01, \c1")
    print("\tsmlabb " + r"\c2, \f01, \g23, \c2")
    print("\tsmladx " + r"\c3, \f01, \g23, \c3")
    print("\tsmladx " + r"\c3, \f23, \g01, \c3")
    print("\tsmlatt " + r"\c4, \f23, \g01, \c4")
    print("\tsmladx " + r"\c5, \f23, \g23, \c5")
    print("\tsmlatt " + r"\c6, \f23, \g23, \c6")
    print("\tpkhbt " + r"\f01, \f23, \f01")
    print("\tsmlad " + r"\c2, \f01, \g01, \c2")
    print("\tsmlad " + r"\c4, \f01, \g23, \c4")
    print(".endm\n")

def polymul_NxN_multipleOf4(N : int, q : int):
    setMacro()
    assert N % 4 == 0
    qinv = round(pow(2,32) / q)
    print(".p2align")
    print(".syntax unified")
    print(".text")
    print(".global gf_polymul_%sx%s" %(N, N))
    print(".type gf_polymul_%sx%s" %(N, N) + r", %function")
    print("gf_polymul_%sx%s" %(N, N) + ":")
    print("\tpush {r4-r11, lr}")
    print("\tmovw.w r3, #%s" %(qinv%65536))
    print("\tmovt.w r3, #%s" %(qinv//65536))
    print("\tmov.w r4, #%s" %(q))
    print("\tvmov s1, s2, r3, r4\n")

    length = N // 4
    print("\tldr.w r4, [r1, #4]")
    print("\tldr.w r3, [r1], #8")
    print("\tldr.w r6, [r2, #4]")
    print("\tldr.w r5, [r2], #8")
    print("\tpolymul_4x4_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
    print("\tvmov s3, r4")
    print("\tvmov r5, r6, s1, s2")
    print("\tbarrett_reduce r7, r5, r6, r4")
    print("\tbarrett_reduce r8, r5, r6, r4")
    print("\tbarrett_reduce r9, r5, r6, r4")
    print("\tbarrett_reduce r10, r5, r6, r4")
    print("\tpkhbt r7, r7, r8, lsl #16")
    print("\tpkhbt r8, r9, r10, lsl #16")
    print("\tvmov r4, s3")
    print("\tstr.w r8, [r0, #4]")
    print("\tstr.w r7, [r0], #8\n")
    
    i=2
    while i < length:
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #-8")
        print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        for j in range(i-2):
            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #-8")
            print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #8")
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #8")
        print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
        print("\tvmov.w s3, r5")
        print("\tvmov r3, r4, s1, s2")
        print("\tbarrett_reduce r7, r3, r4, r5")
        print("\tbarrett_reduce r8, r3, r4, r5")
        print("\tbarrett_reduce r9, r3, r4, r5")
        print("\tbarrett_reduce r10, r3, r4, r5")
        print("\tpkhbt r7, r7, r8, lsl #16")
        print("\tpkhbt r8, r9, r10, lsl #16")
        print("\tvmov.w r5, s3")
        print("\tstr.w r8, [r0, #4]")
        print("\tstr.w r7, [r0], #8\n")
        i+=1
        if not i < length:
            break
        
        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #-8")
        print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        for j in range(i-2):
            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #-8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #8")
            print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #8")
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #8")
        print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
        print("\tvmov.w s3, r4")
        print("\tvmov r5, r6, s1, s2")
        print("\tbarrett_reduce r7, r5, r6, r4")
        print("\tbarrett_reduce r8, r5, r6, r4")
        print("\tbarrett_reduce r9, r5, r6, r4")
        print("\tbarrett_reduce r10, r5, r6, r4")
        print("\tpkhbt r7, r7, r8, lsl #16")
        print("\tpkhbt r8, r9, r10, lsl #16")
        print("\tvmov.w r4, s3")
        print("\tstr.w r8, [r0, #4]")
        print("\tstr.w r7, [r0], #8\n")
        i+=1

    if length % 2 == 1:
        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #-8")
        print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        for j in range(i-2):
            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #-8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #8")
            print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #8")
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #-8")
        print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
        print("\tvmov.w s3, r5")
        print("\tvmov r3, r4, s1, s2")
        print("\tbarrett_reduce r7, r3, r4, r5")
        print("\tbarrett_reduce r8, r3, r4, r5")
        print("\tbarrett_reduce r9, r3, r4, r5")
        print("\tbarrett_reduce r10, r3, r4, r5")
        print("\tpkhbt r7, r7, r8, lsl #16")
        print("\tpkhbt r8, r9, r10, lsl #16")
        print("\tvmov.w r5, s3")
        print("\tstr.w r8, [r0, #4]")
        print("\tstr.w r7, [r0], #8\n")
    else:
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #-8")
        print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        for j in range(length-2):
            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #-8")
            print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

        print("\tldr.w r4, [r1, #4]")
        print("\tldr.w r3, [r1], #-8")
        print("\tldr.w r6, [r2, #4]")
        print("\tldr.w r5, [r2], #8")
        print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
        print("\tvmov.w s3, r4")
        print("\tvmov r5, r6, s1, s2")
        print("\tbarrett_reduce r7, r5, r6, r4")
        print("\tbarrett_reduce r8, r5, r6, r4")
        print("\tbarrett_reduce r9, r5, r6, r4")
        print("\tbarrett_reduce r10, r5, r6, r4")
        print("\tpkhbt r7, r7, r8, lsl #16")
        print("\tpkhbt r8, r9, r10, lsl #16")
        print("\tvmov.w r4, s3")
        print("\tstr.w r8, [r0, #4]")
        print("\tstr.w r7, [r0], #8\n")

    i = length - 1
    while i > 1:
        if i % 2 == 1:
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #8")
            print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

            for j in range(i-2):
                print("\tldr.w r4, [r1, #4]")
                print("\tldr.w r3, [r1], #-8")
                print("\tldr.w r6, [r2, #4]")
                print("\tldr.w r5, [r2], #8")
                print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #-8")
            print("\tpolymul_4x4_accumulate_all_hold_g r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
            print("\tvmov.w s3, r5")
            print("\tvmov r3, r4, s1, s2")
            print("\tbarrett_reduce r7, r3, r4, r5")
            print("\tbarrett_reduce r8, r3, r4, r5")
            print("\tbarrett_reduce r9, r3, r4, r5")
            print("\tbarrett_reduce r10, r3, r4, r5")
            print("\tpkhbt r7, r7, r8, lsl #16")
            print("\tpkhbt r8, r9, r10, lsl #16")
            print("\tvmov.w r5, s3")
            print("\tstr.w r8, [r0, #4]")
            print("\tstr.w r7, [r0], #8\n")
        else:
            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #8")
            print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

            for j in range(i-2):
                print("\tldr.w r4, [r1, #4]")
                print("\tldr.w r3, [r1], #8")
                print("\tldr.w r6, [r2, #4]")
                print("\tldr.w r5, [r2], #-8")
                print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")

            print("\tldr.w r4, [r1, #4]")
            print("\tldr.w r3, [r1], #-8")
            print("\tldr.w r6, [r2, #4]")
            print("\tldr.w r5, [r2], #8")
            print("\tpolymul_4x4_accumulate_all_hold_f r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
            print("\tvmov.w s3, r4")
            print("\tvmov r5, r6, s1, s2")
            print("\tbarrett_reduce r7, r5, r6, r4")
            print("\tbarrett_reduce r8, r5, r6, r4")
            print("\tbarrett_reduce r9, r5, r6, r4")
            print("\tbarrett_reduce r10, r5, r6, r4")
            print("\tpkhbt r7, r7, r8, lsl #16")
            print("\tpkhbt r8, r9, r10, lsl #16")
            print("\tvmov.w r4, s3")
            print("\tstr.w r8, [r0, #4]")
            print("\tstr.w r7, [r0], #8\n")
        
        i-=1

    print("\tldr.w r6, [r2, #4]")
    print("\tldr.w r5, [r2], #8")
    print("\tpolymul_4x4_accumulate_456to012 r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, lr")
    print("\tvmov r3, r4, s1, s2")
    print("\tbarrett_reduce r7, r3, r4, r5")
    print("\tbarrett_reduce r8, r3, r4, r5")
    print("\tbarrett_reduce r9, r3, r4, r5")
    print("\tbarrett_reduce r10, r3, r4, r5")
    print("\tbarrett_reduce r11, r3, r4, r5")
    print("\tbarrett_reduce r12, r3, r4, r5")
    print("\tbarrett_reduce lr, r3, r4, r5")
    print("\tpkhbt r7, r7, r8, lsl #16")
    print("\tpkhbt r8, r9, r10, lsl #16")
    print("\tpkhbt r9, r11, r12, lsl #16")
    print("\tubfx r10, lr, #0, #16")
    print("\tstr.w r7, [r0]")
    print("\tstr.w r8, [r0, #4]")
    print("\tstr.w r9, [r0, #8]")
    print("\tstr.w r10, [r0, #12]")
    print("\tpop {r4-r11, pc}")

if len(sys.argv) < 3:
    print("usage: python3 polymul_4nx4n.py [length] [q]")
    print("e.g. python3 polymul_4nx4n.py 64 4591")
    sys.exit()
length = int(sys.argv[1])
q = int(sys.argv[2])
if length % 4 != 0:
    print("Need that length % 4 == 0")
    sys.exit()

polymul_NxN_multipleOf4(length, q)